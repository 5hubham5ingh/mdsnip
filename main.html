<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mdsnip - Shared Markdown Viewer</title>
    <meta
      name="description"
      content="A minimalist markdown sharing tool with high compression."
    >
    <script src="https://unpkg.com/overtype"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    >
    <style>
      :root {
        --bg-base: #e8e9ea;
        --bg-gradient:
          radial-gradient(
          at 50% 50%,
          rgba(255, 255, 255, 0.8) 0px,
          transparent 60%
        ), radial-gradient(
          at 100% 0%,
          rgba(255, 255, 255, 0.4) 0px,
          transparent 50%
        ), radial-gradient(
          at 0% 100%,
          rgba(255, 255, 255, 0.4) 0px,
          transparent 50%
        );

        --glass-bg: rgba(255, 255, 255, 0.15);
        --glass-border: rgba(0, 0, 0, 0.06);
        --text-main: #111111;
        --accent-color: #000000;
        --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.04);
        --sidebar-width: 240px;
      }

      [data-theme="dark"] {
        --bg-base: #1a1a1a;
        --bg-gradient:
          radial-gradient(
          at 50% 50%,
          rgba(0, 0, 0, 0.6) 0px,
          transparent 60%
        ), radial-gradient(at 0% 0%, rgba(0, 0, 0, 0.3) 0px, transparent 50%),
          radial-gradient(
          at 100% 100%,
          rgba(0, 0, 0, 0.3) 0px,
          transparent 50%
        );

        --glass-bg: rgba(255, 255, 255, 0.02);
        --glass-border: rgba(255, 255, 255, 0.08);
        --text-main: #eeeeee;
        --accent-color: #ffffff;
        --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: var(--bg-base);
        background-image: var(--bg-gradient);
        color: var(--text-main);
        font-family: "Inter", sans-serif;
        align-items: center;
        overflow-x: hidden;
        transition: background 0.6s ease, color 0.6s ease;
      }

      header {
        width: 100%;
        padding: 24px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
      }

      .logo-group {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .logo {
        font-weight: 700;
        font-size: 1.6rem;
        color: var(--accent-color);
        letter-spacing: -0.04em;
      }

      .actions {
        display: flex;
        gap: 12px;
      }

      main {
        width: 92%;
        max-width: 1100px;
        height: calc(100vh - 180px);
        margin-bottom: 40px;
        display: flex; /* Changed to flex-row */
        background: var(--glass-bg);
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        border: 1px solid var(--glass-border);
        border-radius: 32px;
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }

      /* Sidebar Styles */
      #sidebar {
        width: var(--sidebar-width);
        border-right: 1px solid var(--glass-border);
        display: flex;
        flex-direction: column;
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
        overflow: hidden;
        background: rgba(127, 127, 127, 0.03);
      }

      body.sidebar-collapsed #sidebar {
        width: 0;
        opacity: 0;
        border: none;
      }

      .sidebar-content {
        padding: 24px;
        width: var(--sidebar-width);
        overflow-y: auto;
      }
      .sidebar-header {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        opacity: 0.5;
        margin-bottom: 16px;
        font-weight: 700;
      }

      #toc {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .toc-link {
        background: transparent !important;
        border: none !important;
        color: var(--text-main);
        text-align: left;
        padding: 6px 5 !important;
        width: 100%;
        opacity: 0.6;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        box-shadow: none !important;
      }
      .toc-link:hover {
        opacity: 1;
        transform: translateX(4px);
      }
      .toc-h1 {
        font-weight: 600;
      }
      .toc-h2 {
        padding-left: 12px;
        font-size: 13px;
      }
      .toc-h3 {
        padding-left: 24px;
        font-size: 12px;
      }

      #editor-container {
        flex: 1;
        height: 100%;
        overflow: hidden;
      }
      #editor {
        width: 100%;
        height: 100%;
        background: transparent !important;
      }

      button {
        background: var(--glass-bg);
        color: var(--text-main);
        border: 1px solid var(--glass-border);
        padding: 10px 16px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
      }
      button:hover {
        transform: translateY(-1px);
        border-color: var(--text-main);
      }
      button.primary {
        background: var(--text-main);
        color: var(--bg-base);
        border: none;
      }

      #notification {
        position: fixed;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        padding: 12px 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        color: var(--text-main);
        font-size: 14px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
        z-index: 1000;
      }
      #notification.show {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }

      footer {
        width: 100%;
        padding: 16px 40px;
        display: flex;
        justify-content: center;
        gap: 24px;
        font-size: 11px;
        color: var(--text-main);
        opacity: 0.4;
      }
      kbd {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
        margin: 0 2px;
      }

      #loading-overlay {
        position: fixed;
        inset: 0;
        background: var(--bg-base);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        font-weight: 600;
        color: var(--text-main);
      }

      /* Hide Footer/Sidebar on Mobile */
      @media (max-width: 768px) {
        #sidebar {
          display: none;
        }
        #sidebar-toggle {
          display: none;
        }
        footer {
          display: none !important;
        }
        header {
          padding: 16px 20px;
        }
        main {
          width: 95%;
          height: calc(100vh - 140px);
        }
      }

      /* OverType Overrides */
      .ot-root {
        height: 100% !important;
      }
      .overtype-input, .overtype-preview-container {
        background: transparent !important;
      }
      .overtype-toolbar {
        background: rgba(127, 127, 127, 0.05) !important;
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--glass-border) !important;
      }

      .overtype-toolbar-button {
        color: var(--text-main) !important;
      }
      .overtype-toolbar-button:hover {
        transform: translateY(-1px) !important;
        border-color: var(--text-main) !important;
        background: rgba(127, 127, 127, 0.05) !important;
      }

      [data-theme="dark"] .overtype-toolbar {
        background: rgba(0, 0, 0, 0.2) !important;
      }
      body[data-mode="view"] .overtype-toolbar {
        display: none !important;
      }

      /* Custom Scrollbars for all elements */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        /* Light mode default */
        background: rgba(0, 0, 0, 0.1);
        border-radius: 20px;
        border: 2px solid transparent;
        background-clip: content-box;
      }

      /* Dark mode override */
      [data-theme="dark"] ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-main) !important;
        background-clip: content-box;
      }

      /* Firefox Support */
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(127, 127, 127, 0.2) transparent;
      }

      #theme-toggle {
        font-size: 22px;
        padding: 7px 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        height: 38px;
        min-width: 44px;
      }
    </style>
  </head>

  <body data-theme="light" data-mode="view">
    <div id="loading-overlay">Initializing Engine...</div>

    <header>
      <div class="logo-group">
        <button id="sidebar-toggle" title="Toggle Sidebar">☰</button>
        <a href="#" class="logo" style="text-decoration: none; color: inherit"
        >mdsnip</a>
      </div>
      <div class="actions">
        <button id="theme-toggle" title="Toggle Dark Mode">☾</button>
        <button id="mode-toggle" title="Toggle Edit/View Mode">Edit</button>
        <button id="share-btn">Share</button>
      </div>
    </header>

    <main>
      <aside id="sidebar">
        <div class="sidebar-content">
          <div class="sidebar-header">Outline</div>
          <nav id="toc"></nav>
        </div>
      </aside>
      <div id="editor-container">
        <div id="editor"></div>
      </div>
    </main>

    <footer id="desktop-footer">
      <div class="keybind">
        <kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>E</kbd> Write Mode
      </div>
      <div class="keybind">
        <kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>P</kbd> Preview Mode
      </div>
      <div class="keybind">
        <kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>S</kbd> Copy Link
      </div>
    </footer>

    <div id="notification">Link copied to clipboard</div>

    <script src="static/wasm_exec.js"></script>
    <script type="module">
      const shareBtn = document.getElementById("share-btn");
      const themeToggle = document.getElementById("theme-toggle");
      const modeToggle = document.getElementById("mode-toggle");
      const sidebarToggle = document.getElementById("sidebar-toggle");
      const notification = document.getElementById("notification");
      const loadingOverlay = document.getElementById("loading-overlay");
      const tocContainer = document.getElementById("toc");

      let wasmLoaded = false;
      let overtype = null;

      const MONO_THEME = {
        name: "monochrome",
        colors: {
          bgPrimary: "transparent",
          bgSecondary: "transparent",
          text: "var(--text-main)",
          h1: "var(--text-main)",
          codeBg: "rgba(127, 127, 127, 0.1)",
          hr: "var(--glass-border)",
          syntaxMarker: "rgba(127, 127, 127, 0.4)",
          cursor: "var(--text-main)",
          selection: "rgba(127, 127, 127, 0.2)",
        },
      };

      function setMode(mode) {
        document.body.setAttribute("data-mode", mode);
        if (mode === "view") {
          modeToggle.innerHTML = "Edit";
          if (overtype) overtype.showPreviewMode();
        } else {
          modeToggle.innerHTML = "View";
          if (overtype) overtype.showNormalEditMode();
        }
        updateSidebar();
      }

      function updateSidebar() {
        if (!overtype || !tocContainer) return;
        const content = overtype.getValue();
        const headingRegex = /^(#{1,3})\s+(.*)/gm;
        tocContainer.innerHTML = "";

        let match;
        while ((match = headingRegex.exec(content)) !== null) {
          const level = match[1].length;
          const title = match[2].trim();
          const btn = document.createElement("button");
          btn.className = `toc-link toc-h${level}`;
          btn.textContent = title;

          btn.onclick = () => {
            const editorEl = document.getElementById("editor");

            // 1. Find the actual element that has the scrollbar
            // We look for the preview container or the textarea
            const scrollContainer =
              editorEl.querySelector(".overtype-preview-container") ||
              editorEl.querySelector(".overtype-preview") ||
              editorEl.querySelector("textarea") ||
              editorEl.querySelector('[style*="overflow-y: auto"]');

            if (!scrollContainer) return;

            // 2. Find the target header inside that container
            const target = Array.from(
              scrollContainer.querySelectorAll(
                `h1, h2, h3, .overtype-heading`,
              ),
            )
              .find((el) => el.textContent.trim().includes(title));

            if (target) {
              // Determine distance from top of container to the target
              const topPos = target.offsetTop;
              scrollContainer.scrollTo({
                top: topPos - 20, // 20px offset for breathing room
                behavior: "smooth",
              });
            } else if (scrollContainer.tagName === "TEXTAREA") {
              // Fallback for Edit Mode
              const index = content.indexOf(match[0]);
              const linesBefore =
                content.substring(0, index).split("\n").length;
              const lineHeight = 24; // Average line height
              scrollContainer.scrollTo({
                top: (linesBefore - 1) * lineHeight,
                behavior: "smooth",
              });
            }
          };
          tocContainer.appendChild(btn);
        }
      }

      function initOverType(content = "") {
        const [instance] = new OverType("#editor", {
          value: content,
          placeholder: "Start writing...",
          theme: MONO_THEME,
          toolbar: true,
          fontSize: "16px",
        });
        overtype = instance;

        // Sync mode when toolbar buttons are clicked
        document.getElementById("editor").addEventListener(
          "click",
          (e) => {
            if (e.target.closest(".overtype-toolbar-button")) {
              setTimeout(() => {
                const isPreview =
                  !!document.querySelector(".overtype-preview") ||
                  !document.querySelector(".overtype-input");
                const newMode = isPreview ? "view" : "write";
                if (
                  document.body.getAttribute("data-mode") !== newMode
                ) setMode(newMode);
              }, 50);
            }
          },
        );

        // Update sidebar as you type
        document.getElementById("editor").addEventListener(
          "input",
          updateSidebar,
        );
        setMode(document.body.getAttribute("data-mode") || "view");
      }

      // Sidebar Toggle
      sidebarToggle.addEventListener("click", () => {
        document.body.classList.toggle("sidebar-collapsed");
      });

      // Mode Toggle
      modeToggle.addEventListener("click", () => {
        const currentMode = document.body.getAttribute("data-mode");
        setMode(currentMode === "view" ? "write" : "view");
      });

      // Theme Toggle
      themeToggle.addEventListener("click", () => {
        const isDark =
          document.body.getAttribute("data-theme") === "dark";
        document.body.setAttribute(
          "data-theme",
          isDark ? "light" : "dark",
        );
        themeToggle.textContent = isDark ? "☾" : "☼";
      });

      // WASM Loader
      const go = new Go();
      WebAssembly.instantiateStreaming(
        fetch("static/main.wasm"),
        go.importObject,
      ).then((result) => {
        go.run(result.instance);
        wasmLoaded = true;
        loadingOverlay.style.display = "none";
        handleInitialData();
      }).catch((err) => {
        loadingOverlay.innerHTML = "Error loading engine.";
      });

      function handleInitialData() {
        const hash = window.location.hash.substring(1);
        if (hash) {
          const decompressed = window.decompressMarkdown(hash);
          initOverType(
            decompressed && !decompressed.startsWith("Error:")
              ? decompressed
              : "# Error\nInvalid data.",
          );
          setMode("view");
        } else {
          initOverType("");
          setMode("write");
        }
      }

      shareBtn.addEventListener("click", () => {
        if (!wasmLoaded || !overtype) return;
        const content = overtype.getValue();
        if (!content.trim()) return alert("Write something first!");
        const compressed = window.compressMarkdown(content);
        const url =
          `${window.location.origin}${window.location.pathname}#${compressed}`;
        navigator.clipboard.writeText(url).then(() => {
          notification.textContent = "Link copied to clipboard";
          notification.classList.add("show");
          setTimeout(() => notification.classList.remove("show"), 3000);
        });
      });

      // Shortcuts
      window.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.shiftKey) {
          const key = e.key.toLowerCase();
          if (key === "e") {
            e.preventDefault();
            setMode("write");
          }
          if (key === "p") {
            e.preventDefault();
            setMode("view");
          }
          if (key === "s") {
            e.preventDefault();
            shareBtn.click();
          }
        }
      });
    </script>
  </body>
</html>
